{% extends "web/base.html" %}
{% load static %}

{% block title %}Compound detail{% endblock %}

{% block content %}
<style>
  th {
    white-space: nowrap !important;
    width: 1% !important;
    min-width: 140px !important;
    padding-right: 50px !important;
  }

  /* è¡¨å¤´ç»Ÿä¸€è“è‰²é£æ ¼ */
  .table-info > th,
  .table-info > td,
  thead.table-info > tr > th {
    background-color: rgb(64, 158, 255) !important;
    color: white !important;
  }

  .pubchem-link {
  font-size: 0.85em;       /* æ¯”æ­£æ–‡å°ä¸€ç‚¹ */
  color: #6c757d;          /* Bootstrap ç°è‰² */
  margin-left: 8px;        /* å’Œåå­—ç•™ç‚¹ç©ºéš™ */
  text-decoration: none;   /* é»˜è®¤ä¸å¸¦ä¸‹åˆ’çº¿ */
  }

  .pubchem-link:hover {
    color: #0d6efd;          /* æ‚¬åœæ—¶å˜æˆ Bootstrap è“è‰² */
    text-decoration: underline;
  }
</style>

<div>
  <div style="-webkit-text-size-adjust: 100%;
              -webkit-tap-highlight-color: transparent;
              font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
              font-size: 20px;
              line-height: 1.428571429;
              color: #333333;
              box-sizing: border-box;
              padding-bottom: 10px;
              margin: 40px 0 20px;
              border-bottom: 2px solid #eeeeee;">
      {{ compound.standard }}
      <a href="/compound/list/" class="btn btn-primary btn-sm">Back</a>
  </div>
</div>

<!-- Content -->
<div class="container-fluid mt-4">
  <table class="table w-100 table-bordered table-hover">
    <tbody>
      <!-- General Information -->
      <tr class="table-info">
        <th class="divider" colspan="2">Compound Information</th>
      </tr>
      <tr>
        <th>Compound name</th>
        <td>
          <strong>{{ compound.standard }}</strong>
          <a href="https://pubchem.ncbi.nlm.nih.gov/#query={{ compound.standard|urlencode }}&tab=compound" 
            target="_blank" 
            class="pubchem-link"
            title="åœ¨ PubChem ä¸­æœç´¢">
            ğŸ”— PubChem
          </a>
        </td>
      </tr>
      <tr>
        <th>SMILES</th>
        <td>{{ compound.smiles }}</td>
      </tr>
      <tr>
        <th>Ion Mode</th>
        <td>{{ compound.ionmode }}</td>
      </tr>
      <tr>
        <th>Database source</th>
        <td>{{ compound.database }}</td>
      </tr>
      <tr>
        <th>RT in Seconds</th>
        <td>{{ compound.rtinseconds }}</td>
      </tr>
      <tr>
        <th>PEPMASS</th>
        <td>{{ compound.pepmass|floatformat:4 }}</td>
      </tr>
      <tr>
        <th>Structure</th>
        <td>
          {% if mol_img %}
          <img src="data:image/png;base64,{{ mol_img }}" class="img-thumbnail" />
          {% endif %}
        </td>
      </tr>
    </tbody>
  </table>

  {# ---------- Herb Sources ------------- #}
  <h3 class="mt-5">Herb Sources</h3>
  <table class="table w-100 table-bordered table-hover">
    <thead class="table-info">
      <tr>
        <th>Chinese Name</th>
        <th>Latin Name</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for ps in plant_sources %}
        <tr>
            <td>{{ ps.chinese_name }}</td>
            <td>{{ ps.latin_name }}</td>
            <td><a href="{% url 'herb_compound_detail' latin_name=ps.latin_slug compound=ps.compound_url %}" class="btn btn-sm btn-outline-primary">View</a></td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="2" class="text-muted">No herb recorded for this compound.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if similar_samples %}
  <h3 class="mt-5">Plants Containing Similar Compounds</h3>
  <table id="similar-samples-table" class="table w-100 table-bordered table-hover mb-3">
    <thead class="table-info">
      <tr>
        <th>Latin Name</th>
        <th>Chinese Name</th>
        <th>Tissue</th>
        <th>Similarity Score</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
        {% for item in similar_samples %}
          <tr>
            <td>{{ item.latin_name }}</td>
            <td>{{ item.chinese_name }}</td>
            <td>{{ item.tissue }}</td>
            <td>{{ item.score|floatformat:3 }}</td>
            <td><a href="{% url 'similar_compare' compound_id=compound.id spectrum_idx=item.spectrum_idx %}?score={{ item.score }}" class="btn btn-sm btn-outline-primary">View</a></td>
          </tr>
        {% endfor %}
    </tbody>
  </table>

  <!-- åˆ†é¡µä¿¡æ¯å’Œå¯¼èˆª -->
  <div id="similar-pagination" class="pagination-holder d-flex justify-content-between align-items-center mt-3"></div>
  {% endif %}

  <script>
  document.addEventListener("DOMContentLoaded", function() {
      const table = document.querySelector("#similar-samples-table tbody");
      const rows = Array.from(table.querySelectorAll("tr"));
      const pageSize = 15;   // æ¯é¡µ 15 æ¡
      let currentPage = 1;

      function renderPage(page) {
          currentPage = page;
          const start = (page - 1) * pageSize;
          const end = start + pageSize;
          
          rows.forEach((row, i) => {
              row.style.display = (i >= start && i < end) ? "" : "none";
          });
          renderPagination();
      }

      function renderPagination() {
          const total = rows.length;
          const totalPages = Math.ceil(total / pageSize);
          const startIndex = (currentPage - 1) * pageSize + 1;
          const endIndex = Math.min(currentPage * pageSize, total);

          let html = `
            <div class="page_info">
                Displaying <b>${startIndex} - ${endIndex}</b> of <b>${total}</b> in total
            </div>
            <ul class="pagination pagination-sm mb-0">
          `;

          if (currentPage > 1) {
              html += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage-1}">â€¹ Prev</a></li>`;
          }

          // é¡µç èŒƒå›´ï¼ˆå½“å‰é¡µå‰å 2 é¡µï¼‰
          let startPage = Math.max(1, currentPage - 2);
          let endPage = Math.min(totalPages, currentPage + 2);

          if (startPage > 1) {
              html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
              if (startPage > 2) {
                  html += `<li class="page-item disabled"><a class="page-link" href="#">â€¦</a></li>`;
              }
          }

          for (let i = startPage; i <= endPage; i++) {
              html += `<li class="page-item ${i===currentPage ? "active":""}">
                          <a class="page-link" href="#" data-page="${i}">${i}</a>
                      </li>`;
          }

          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  html += `<li class="page-item disabled"><a class="page-link" href="#">â€¦</a></li>`;
              }
              html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
          }

          if (currentPage < totalPages) {
              html += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage+1}">Next â€º</a></li>`;
          }

          html += `</ul>`;
          document.querySelector("#similar-pagination").innerHTML = html;

          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          document.querySelectorAll("#similar-pagination a[data-page]").forEach(a => {
              a.addEventListener("click", function(e) {
                  e.preventDefault();
                  renderPage(parseInt(this.dataset.page));
              });
          });
      }

      renderPage(1); // é»˜è®¤æ˜¾ç¤ºç¬¬ 1 é¡µ
  });
  </script>

</div>


<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<hr>
{% endblock %}
