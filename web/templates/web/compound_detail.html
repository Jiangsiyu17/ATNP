{% extends "web/base.html" %}
{% load static %}

{% block title %}Compound detail{% endblock %}

{% block content %}
<style>
  th {
    white-space: nowrap !important;
    width: 1% !important;
    min-width: 140px !important;
    padding-right: 50px !important;
  }

  .table-info > th,
  .table-info > td,
  thead.table-info > tr > th {
    background-color: rgb(64, 158, 255) !important;
    color: white !important;
  }

  .pubchem-link {
    font-size: 0.85em;
    color: #6c757d;
    margin-left: 8px;
    text-decoration: none;
  }

  .pubchem-link:hover {
    color: #0d6efd;
    text-decoration: underline;
  }
</style>

<div>
  <div style="font-size:20px;margin:40px 0 20px;border-bottom:2px solid #eee;padding-bottom:10px;">
      {{ compound.standard }}
      <a href="/compound/list/" class="btn btn-primary btn-sm">Back</a>
  </div>
</div>

<!-- ================= Compound Information ================= -->
<table class="table w-100 table-bordered table-hover mb-4">
  <tr class="table-info">
      <th class="text-center fs-5 py-2" colspan="2">Compound Information</th>
  </tr>

  <tr>
    <td colspan="2">
      <div class="row">

        <div class="col-md-4 text-center">
            {% if mol_img %}
              <img src="data:image/png;base64,{{ mol_img }}" class="img-fluid img-thumbnail">
            {% else %}
              <p class="text-muted">No structure available</p>
            {% endif %}
        </div>

        <div class="col-md-8">
          <table class="table table-sm table-borderless mb-4">
            <tbody>
              <tr>
                <th class="text-end">Compound Name</th>
                <td><strong>{{ compound.standard }}</strong></td>
              </tr>
              {% if compound.inchikey %}
              <tr>
                <th class="text-end">InChIKey</th>
                <td>
                  {{ compound.inchikey }}
                  <a href="https://pubchem.ncbi.nlm.nih.gov/#query={{ compound.inchikey }}&tab=compound"
                     target="_blank" class="pubchem-link">ðŸ”— PubChem</a>
                </td>
              </tr>
              {% endif %}
              <tr>
                <th class="text-end">Database</th>
                <td>{{ compound.database }}</td>
              </tr>
              <tr>
                <th class="text-end">PEPMASS</th>
                <td>{{ compound.precursor_mz|floatformat:4 }}</td>
              </tr>
            </tbody>
          </table>

          {% if rdkit %}
          <div class="bg-light p-2 rounded mb-2 fw-semibold border">
            Calculated Properties
          </div>
          <table class="table table-sm table-borderless">
            <tbody>
              <tr>
                <th class="text-end">Molecular Weight</th><td>{{ rdkit.mol_weight }}</td>
                <th class="text-end">HBD</th><td>{{ rdkit.hbd }}</td>
                <th class="text-end">LogP</th><td>{{ rdkit.logp }}</td>
              </tr>
              <tr>
                <th class="text-end">Rings</th><td>{{ rdkit.num_rings }}</td>
                <th class="text-end">HBA</th><td>{{ rdkit.hba }}</td>
                <th class="text-end">QED</th><td>{{ rdkit.qed }}</td>
              </tr>
              <tr>
                <th class="text-end">Aromatic Rings</th><td>{{ rdkit.num_aromatic_rings }}</td>
                <th class="text-end">Rotatable Bonds</th><td>{{ rdkit.rotatable_bonds }}</td>
                <th class="text-end">SA Score</th><td>{{ rdkit.sa_score }}</td>
              </tr>
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>
    </td>
  </tr>
</table>

<br>

<!-- ================= Herb Sources ================= -->
<table class="table w-100 table-bordered table-hover mb-4">
  <thead class="table-info">
    <tr><th class="text-center fs-5 py-2" colspan="7">Herb Sources</th></tr>
  </thead>
  <tr class="table-secondary fw-bold">
    <th>#</th><th>Chinese Name</th><th>Latin Name</th>
    <th>Tissue</th><th>Precursor m/z</th><th>Ion mode</th><th></th>
  </tr>
  <tbody>
    {% for ps in plant_sources.object_list %}
    <tr>
      <td>{{ forloop.counter0|add:plant_sources.start_index }}</td>
      <td>{{ ps.chinese_name }}</td>
      <td>{{ ps.latin_name }}</td>
      <td>{{ ps.tissue }}</td>
      <td>{{ ps.precursor_mz|floatformat:4 }}</td>
      <td>{{ ps.ionmode }}</td>
      <td>
        <a href="{% url 'herb_compound_detail' latin_name=ps.latin_slug compound_id=compound.id %}?pid={{ ps.pid }}"
           class="btn btn-sm btn-outline-primary">View</a>
      </td>
    </tr>
    {% empty %}
      <tr><td colspan="7" class="text-muted">No herb recorded.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Herb pagination -->
<div class="pagination-holder d-flex justify-content-between align-items-center mt-3">
  <div class="page_info">
    Displaying <b>{{ plant_sources.start_index }} - {{ plant_sources.end_index }}</b>
    of <b>{{ plant_sources.paginator.count }}</b>
  </div>
  <ul class="pagination pagination-sm mb-0">
    {% if plant_sources.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?plant_page={{ plant_sources.previous_page_number }}">â€¹ Prev</a>
      </li>
    {% endif %}
    {% for num in plant_sources.paginator.page_range %}
      {% if num >= plant_sources.number|add:"-2" and num <= plant_sources.number|add:"2" %}
      <li class="page-item {% if num == plant_sources.number %}active{% endif %}">
        <a class="page-link" href="?plant_page={{ num }}">{{ num }}</a>
      </li>
      {% endif %}
    {% endfor %}
    {% if plant_sources.has_next %}
      <li class="page-item">
        <a class="page-link" href="?plant_page={{ plant_sources.next_page_number }}">Next â€º</a>
      </li>
    {% endif %}
  </ul>
</div>

<br><br>

<!-- ================= Similar Samples ================= -->
{% if similar_samples %}
<table class="table w-100 table-bordered table-hover mb-4">
  <thead class="table-info">
    <tr><th class="text-center fs-5 py-2" colspan="8">Plants Containing Similar Compounds</th></tr>
  </thead>
  <tr class="table-secondary fw-bold">
    <th>#</th><th>Chinese Name</th><th>Latin Name</th>
    <th>Tissue</th><th>Precursor m/z</th><th>Ion mode</th>
    <th>Similarity</th><th></th>
  </tr>
  <tbody>
    {% for s in similar_samples.object_list %}
    <tr>
      <td>{{ forloop.counter0|add:similar_samples.start_index }}</td>
      <td>{{ s.chinese_name }}</td>
      <td>{{ s.latin_name }}</td>
      <td>{{ s.tissue }}</td>
      <td>{{ s.precursor_mz|floatformat:4 }}</td>
      <td>{{ s.ionmode }}</td>
      <td>{{ s.score|floatformat:3 }}</td>
      <td>
        <a href="{% url 'similar_compare' compound_id=compound.id spectrum_idx=s.spectrum_idx %}?score={{ s.score }}"
           class="btn btn-sm btn-outline-primary">View</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Similar pagination -->
<div class="pagination-holder d-flex justify-content-between align-items-center mt-3">
  <div class="page_info">
    Displaying <b>{{ similar_samples.start_index }} - {{ similar_samples.end_index }}</b>
    of <b>{{ similar_samples.paginator.count }}</b>
  </div>

  <ul class="pagination pagination-sm mb-0">
    {% if similar_samples.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?sample_page={{ similar_samples.previous_page_number }}&plant_page={{ plant_sources.number }}">
           â€¹ Prev
        </a>
      </li>
    {% endif %}

    {% for num in similar_samples.paginator.page_range %}
      {% if num >= similar_samples.number|add:"-2" and num <= similar_samples.number|add:"2" %}
      <li class="page-item {% if num == similar_samples.number %}active{% endif %}">
        <a class="page-link"
           href="?sample_page={{ num }}&plant_page={{ plant_sources.number }}">
           {{ num }}
        </a>
      </li>
      {% endif %}
    {% endfor %}

    {% if similar_samples.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?sample_page={{ similar_samples.next_page_number }}&plant_page={{ plant_sources.number }}">
           Next â€º
        </a>
      </li>
    {% endif %}
  </ul>
</div>
{% endif %}

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<hr>
{% endblock %}
